name: ğŸ“… Daily Documentation Crawl & Deploy

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Manual trigger

defaults:
  run:
    shell: bash

jobs:
  crawl-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    # Prevent multiple crawl operations from running simultaneously
    concurrency:
      group: daily-crawl
      cancel-in-progress: false
    
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ§… Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile
        
      - name: ğŸ‘€ Environment info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "SHA:        ${{ github.sha }}"
          echo "Bun ver:    $(bun --version)"
          echo "Node ver:   $(node --version)"
          echo "Crawl time: $(date)"
        
      - name: ğŸ•·ï¸ Run documentation crawl
        run: |
          echo "ğŸ•·ï¸ Starting documentation crawl..."
          bun run crawl --force-reindex
          echo "âœ… Crawl completed successfully!"
        
      - name: âœ… Verify crawl output
        run: |
          if [ ! -f "public/docs-index.json" ]; then
            echo "âŒ Crawl failed - no output file generated"
            exit 1
          fi
          
          echo "ğŸ“Š Crawl statistics:"
          echo "   File size: $(du -h public/docs-index.json | cut -f1)"
          echo "   Line count: $(wc -l < public/docs-index.json)"
          echo "   Last modified: $(date -r public/docs-index.json)"
          
          # Basic JSON validation
          if ! bun -e "JSON.parse(await Bun.file('public/docs-index.json').text())"; then
            echo "âŒ Generated JSON is invalid"
            exit 1
          fi
          
          echo "âœ… Crawl output validation passed!"
          
      - name: ğŸ”¨ Build project with updated content
        id: build_artifacts
        run: |
          echo "ğŸš€ Building project with fresh crawl data..."
          bun run build
          
          # Add .nojekyll for proper static hosting
          touch dist/.nojekyll
          
          echo "ğŸ“Š Build summary with updated content:"
          du -sh dist/
          echo "Total files: $(find dist -type f | wc -l)"
          echo "Index file included: $([ -f 'dist/docs-index.json' ] && echo 'Yes' || echo 'No')"
        env:
          NODE_ENV: production
          
      - name: ğŸš€ Deploy index to ArNS (Dedicated Index Undername)
        id: deploy_index_arns
        run: |
          echo "ğŸ“Š Deploying crawled index to dedicated ArNS undername..."
          
          # Verify build artifacts exist
          if [ ! -d "dist" ]; then
            echo "âŒ Build artifacts not found"
            exit 1
          fi
          
          npx permaweb-deploy \
            --undername=index \
            --ant-process=${{ secrets.ANT_PROCESS }} \
            --deploy-folder=dist \
            --verbose
          
          echo "deployment_url=https://index_permaweb-llms-builder.ar.io" >> $GITHUB_OUTPUT
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          ANT_PROCESS: ${{ secrets.ANT_PROCESS }}
          
      - name: ğŸš€ Deploy index to Vercel (Fast Access Mirror)
        id: deploy_index_vercel
        run: |
          echo "ğŸŒ Deploying crawled index to Vercel for fast access..."
          bun run deploy:preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          
      - name: ğŸ“ Report crawl & deployment summary
        run: |
          echo "## ğŸ“Š Daily Crawl & Index Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Index file size**: $(du -h public/docs-index.json | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total entries**: $(wc -l < public/docs-index.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build artifacts**: $(find dist -type f | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- **Index (ArNS)**: âœ… ${{ steps.deploy_index_arns.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Index (Vercel)**: âœ… Fast mirror deployed" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "ğŸ‰ Daily index update complete!"
          echo "Index ArNS: ${{ steps.deploy_index_arns.outputs.deployment_url }}"
          echo "Index access: ${{ steps.deploy_index_arns.outputs.deployment_url }}/docs-index.json" 